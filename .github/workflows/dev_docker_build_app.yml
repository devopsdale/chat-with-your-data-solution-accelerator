# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions
# More info on Python, GitHub Actions, and Azure App Service: https://aka.ms/python-webapps-actions

name: DEV - build and release api

on:
  push:
    branches:
      - development
  workflow_dispatch:

jobs:
        
  deploy-to-dev:
    runs-on: ubuntu-latest
    environment:
      name: 'production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    permissions:
      id-token: write #This is required for requesting the JWT
      
    steps:
    # checkout the repo
    - name: 'Checkout Github Action'
      uses: actions/checkout@master

    - uses: azure/docker-login@v1
      with:
        login-server: prontoacr.azurecr.io
        username: ${{ secrets.REGISTRY_USERNAME }}
        password: ${{ secrets.REGISTRY_PASSWORD }}


    - run: |
        docker build --build-arg  . -t prontoacr.azurecr.io/pronto-fontend:dev -f ./docker/Frontend.Dockerfile
        docker push prontoacr.azurecr.io/pronto-fontend

    - name: Login to Azure
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_1EC8C71974184A14A7AFB91F4676FE53 }}
        tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_C68709E83D0B4B41815059C3FCED7A93 }}
        subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_991984B989F44817B0925FB42F086658 }}                        
    
    - uses: azure/webapps-deploy@v2
      with:
        app-name: 'web-dsfb352ephiyu'
        images:  prontoacr.azurecr.io/pronto-fontend

  # deploy-to-prod:
  #   runs-on: ubuntu-latest
  #   environment:
  #     name: 'prod'
  #     url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
  #   permissions:
  #     id-token: write #This is required for requesting the JWT
      
  #   steps:
  #   # checkout the repo
  #   - name: 'Checkout Github Action'
  #     uses: actions/checkout@master

  #   - uses: azure/docker-login@v1
  #     with:
  #       login-server: prontoacr.azurecr.io
  #       username: ${{ secrets.REGISTRY_USERNAME }}
  #       password: ${{ secrets.REGISTRY_PASSWORD }}


  #   - run: |
  #       docker build --build-arg . -t prontoacr.azurecr.io/pronto-fontend:prod -f ./docker/Frontend.Dockerfile
  #       docker push prontoacr.azurecr.io/pronto-fontend

  #   - name: Login to Azure
  #     uses: azure/login@v1
  #     with:
  #       client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_4B43FB76407F413790F02195360898CA }}
  #       tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_610C1234047F4513B68891CEE4A42C47 }}
  #       subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_B2F23215E1C74F3DA47CBB5DC82A8B96 }}                         
    
  #   - uses: azure/webapps-deploy@v2
  #     with:
  #       app-name: 'web-dsfb352ephiyu'
  #       images:  prontoacr.azurecr.io/pronto-fontend      
