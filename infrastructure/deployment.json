{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "ResourcePrefix": {
            "type": "string",
            "metadata": {
                "description": "provide a 2-13 character prefix for all resources."
            }
        },
        "HostingPlanName": {
            "type": "string",
            "defaultValue": "[concat(parameters('ResourcePrefix'), '-hosting-plan')]",
            "metadata": {
                "description": "Name of App Service plan"
            }
        },
        "HostingPlanSku": {
            "type": "string",
            "defaultValue": "B3",
            "allowedValues": [
                "F1",
                "D1",
                "B1",
                "B2",
                "B3",
                "S1",
                "S2",
                "S3",
                "P1",
                "P2",
                "P3",
                "P4"
            ],
            "metadata": {
                "description": "The pricing tier for the App Service plan"
            }
        },
        "WebsiteName": {
            "type": "string",
            "defaultValue": "[concat(parameters('ResourcePrefix'), '-website')]",
            "metadata": {
                "description": "Name of Web App"
            }
        },
        "ApplicationInsightsName": {
            "type": "string",
            "defaultValue": "[concat(parameters('ResourcePrefix'), '-appinsights')]",
            "metadata": {
                "description": "Name of Application Insights"
            }
        },
        "AzureSearchUseSemanticSearch": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Use semantic search"
            }
        },
        "AzureSearchSemanticSearchConfig": {
            "type": "string",
            "defaultValue": "default",
            "metadata": {
                "description": "Semantic search config"
            }
        },
        "AzureSearchIndexIsPrechunked": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Is the index prechunked"
            }
        },
        "AzureSearchTopK": {
            "type": "int",
            "defaultValue": 5,
            "metadata": {
                "description": "Top K results"
            }
        },
        "AzureSearchEnableInDomain": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Enable in domain"
            }
        },
        "AzureSearchContentColumns": {
            "type": "string",
            "defaultValue": "content",
            "metadata": {
                "description": "Content columns"
            }
        },
        "AzureSearchFilenameColumn": {
            "type": "string",
            "defaultValue": "filename",
            "metadata": {
                "description": "Filename column"
            }
        },
        "AzureSearchTitleColumn": {
            "type": "string",
            "defaultValue": "title",
            "metadata": {
                "description": "Title column"
            }
        },
        "AzureSearchUrlColumn": {
            "type": "string",
            "defaultValue": "url",
            "metadata": {
                "description": "Url column"
            }
        },
        "AzureOpenAIResource": {
            "type": "string",
            "metadata": {
                "description": "Name of Azure OpenAI Resource"
            }
        },
        "AzureOpenAIModel": {
            "type": "string",
            "metadata": {
                "description": "Azure OpenAI Model Deployment Name"
            }
        },
        "AzureOpenAIModelName": {
            "type": "string",
            "defaultValue": "gpt-35-turbo",
            "metadata": {
                "description": "Azure OpenAI Model Name"
            }
        },
        "AzureOpenAIKey": {
            "type": "securestring",
            "metadata": {
                "description": "Azure OpenAI Key"
            }
        },
        "AzureOpenAITemperature": {
            "type": "int",
            "defaultValue": 0,
            "metadata": {
                "description": "Azure OpenAI Temperature"
            }
        },
        "AzureOpenAITopP": {
            "type": "int",
            "defaultValue": 1,
            "metadata": {
                "description": "Azure OpenAI Top P"
            }
        },
        "AzureOpenAIMaxTokens": {
            "type": "int",
            "defaultValue": 1000,
            "metadata": {
                "description": "Azure OpenAI Max Tokens"
            }
        },
        "AzureOpenAIStopSequence": {
            "type": "string",
            "defaultValue": "\n",
            "metadata": {
                "description": "Azure OpenAI Stop Sequence"
            }
        },
        "AzureOpenAISystemMessage": {
            "type": "string",
            "defaultValue": "You are an AI assistant that helps people find information.",
            "metadata": {
                "description": "Azure OpenAI System Message"
            }
        },
        "AzureOpenAIApiVersion": {
            "type": "string",
            "defaultValue": "2023-06-01-preview",
            "metadata": {
                "description": "Azure OpenAI Api Version"
            }
        },
        "AzureOpenAIStream": {
            "type": "bool",
            "defaultValue": true,
            "metadata": {
                "description": "Whether or not to stream responses from Azure OpenAI"
            }
        },
        "AzureOpenAIDeploymentType": {
            "type": "string",
            "defaultValue": "Chat",
            "metadata": {
                "description": "Azure OpenAI Deployment Type. Text (e.g. text-davinci-003) or Chat (e.g. gpt-35-turbo or gpt-4)"
            }
        },
        "AzureOpenAIEmbeddingModel": {
            "type": "string",
            "defaultValue": "text-embedding-ada-002",
            "metadata": {
                "description": "Azure OpenAI Embedding Model"
            }
        },
        "AzureCognitiveSearch": {
            "type": "string",
            "defaultValue": "[concat(parameters('ResourcePrefix'), '-search')]",
            "metadata": {
                "description": "Azure Cognitive Search Resource"
            }
        },
        "AzureCognitiveSearchSku": {
            "type": "string",
            "defaultValue": "standard",
            "allowedValues": [
                "free",
                "basic",
                "standard",
                "standard2",
                "standard3"
            ],
            "metadata": {
                "description": "The SKU of the search service you want to create. E.g. free or standard"
            }
        },
        "AzureSearchIndex": {
            "type": "string",
            "defaultValue": "[concat(parameters('ResourcePrefix'), '-index')]",
            "metadata": {
                "description": "Azure Cognitive Search Index"
            }
        },
        "StorageAccountName": {
            "type": "string",
            "defaultValue": "[concat(parameters('ResourcePrefix'), 'str')]",
            "metadata": {
                "description": "Name of Storage Account"
            }
        },
        "FunctionName": {
            "type": "string",
            "defaultValue": "[concat(parameters('ResourcePrefix'), '-backend')]",
            "metadata": {
                "description": "Name of Function App for Batch document processing"
            }
        },
        "FormRecognizerName": {
            "type": "string",
            "defaultValue": "[concat(parameters('ResourcePrefix'), '-formrecog')]",
            "metadata": {
                "description": "Azure Form Recognizer Name"
            }
        },
        "newGuid": {
            "type": "string",
            "defaultValue": "[newGuid()]"
        }
    },
    "variables": {
        "WebAppImageName": "DOCKER|fruoccopublic.azurecr.io/rag-webapp",
        "AdminWebAppImageName": "DOCKER|fruoccopublic.azurecr.io/rag-adminwebapp",
        "BackendImageName": "DOCKER|fruoccopublic.azurecr.io/rag-backend",
        "BlobContainerName": "documents",
        "QueueName": "doc-processing",
        "ClientKey": "[concat(uniqueString(guid(resourceGroup().id, deployment().name)), parameters('newGuid'))]"
    },
    "resources": [
        {
            "apiVersion": "2015-08-19",
            "name": "[parameters('AzureCognitiveSearch')]",
            "type": "Microsoft.Search/searchServices",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "[parameters('AzureCognitiveSearchSku')]"
            },
            "properties": {
                "replicaCount": 1,
                "partitionCount": 1
            }
        },
        {
            "type": "Microsoft.CognitiveServices/accounts",
            "apiVersion": "2022-12-01",
            "name": "[parameters('FormRecognizerName')]",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "S0"
            },
            "kind": "FormRecognizer",
            "identity": {
                "type": "None"
            },
            "properties": {
                "networkAcls": {
                    "defaultAction": "Allow",
                    "virtualNetworkRules": [],
                    "ipRules": []
                },
                "publicNetworkAccess": "Enabled"
            }
        },
        {
            "apiVersion": "2020-06-01",
            "name": "[parameters('HostingPlanName')]",
            "type": "Microsoft.Web/serverfarms",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "[parameters('HostingPlanSku')]"
            },
            "properties": {
                "name": "[parameters('HostingPlanName')]",
                "reserved": true
            },
            "kind": "linux"
        },
        {
            "apiVersion": "2020-06-01",
            "name": "[parameters('WebsiteName')]",
            "type": "Microsoft.Web/sites",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('HostingPlanName'))]"
            ],
            "properties": {
                "serverFarmId": "[parameters('HostingPlanName')]",
                "siteConfig": {
                    "appSettings": [
                        {
                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                            "value": "[reference(resourceId('Microsoft.Insights/components', parameters('ApplicationInsightsName')), '2015-05-01').InstrumentationKey]"
                        },
                        {
                            "name": "AZURE_SEARCH_SERVICE",
                            "value": "[parameters('AzureCognitiveSearch')]"
                        },
                        {
                            "name": "AZURE_SEARCH_INDEX",
                            "value": "[parameters('AzureSearchIndex')]"
                        },
                        {
                            "name": "AZURE_SEARCH_KEY",
                            "value": "[listAdminKeys(concat('Microsoft.Search/searchServices/', parameters('AzureCognitiveSearch')), '2021-04-01-preview').primaryKey]"
                        },
                        {
                            "name": "AZURE_SEARCH_SEMANTIC_SEARCH_CONFIG",
                            "value": "[parameters('AzureSearchSemanticSearchConfig')]"
                        },
                        {
                            "name": "AZURE_SEARCH_INDEX_IS_PRECHUNKED",
                            "value": "[parameters('AzureSearchIndexIsPrechunked')]"
                        },
                        {
                            "name": "AZURE_SEARCH_TOP_K",
                            "value": "[parameters('AzureSearchTopK')]"
                        },
                        {
                            "name": "AZURE_SEARCH_ENABLE_IN_DOMAIN",
                            "value": "[parameters('AzureSearchEnableInDomain')]"
                        },
                        {
                            "name": "AZURE_SEARCH_CONTENT_COLUMNS",
                            "value": "[parameters('AzureSearchContentColumns')]"
                        },
                        {
                            "name": "AZURE_SEARCH_FILENAME_COLUMN",
                            "value": "[parameters('AzureSearchFilenameColumn')]"
                        },
                        {
                            "name": "AZURE_SEARCH_TITLE_COLUMN",
                            "value": "[parameters('AzureSearchTitleColumn')]"
                        },
                        {
                            "name": "AZURE_SEARCH_URL_COLUMN",
                            "value": "[parameters('AzureSearchUrlColumn')]"
                        },
                        {
                            "name": "AZURE_OPENAI_RESOURCE",
                            "value": "[parameters('AzureOpenAIResource')]"
                        },
                        {
                            "name": "AZURE_OPENAI_MODEL",
                            "value": "[parameters('AzureOpenAIModel')]"
                        },
                        {
                            "name": "AZURE_OPENAI_KEY",
                            "value": "[parameters('AzureOpenAIKey')]"
                        },
                        {
                            "name": "AZURE_OPENAI_MODEL_NAME",
                            "value": "[parameters('AzureOpenAIModelName')]"
                        },
                        {
                            "name": "AZURE_OPENAI_TEMPERATURE",
                            "value": "[parameters('AzureOpenAITemperature')]"
                        },
                        {
                            "name": "AZURE_OPENAI_TOP_P",
                            "value": "[parameters('AzureOpenAITopP')]"
                        },
                        {
                            "name": "AZURE_OPENAI_MAX_TOKENS",
                            "value": "[parameters('AzureOpenAIMaxTokens')]"
                        },
                        {
                            "name": "AZURE_OPENAI_STOP_SEQUENCE",
                            "value": "[parameters('AzureOpenAIStopSequence')]"
                        },
                        {
                            "name": "AZURE_OPENAI_SYSTEM_MESSAGE",
                            "value": "[parameters('AzureOpenAISystemMessage')]"
                        },
                        {
                            "name": "AZURE_OPENAI_API_VERSION",
                            "value": "[parameters('AzureOpenAIApiVersion')]"
                        },
                        {
                            "name": "AZURE_OPENAI_STREAM",
                            "value": "[parameters('AzureOpenAIStream')]"
                        },
                        {
                            "name": "OPENAI_EMBEDDINGS_ENGINE_DOC",
                            "value": "[parameters('AzureOpenAIEmbeddingModel')]"
                        },
                        {
                            "name": "OPENAI_DEPLOYMENT_TYPE",
                            "value" : "[parameters('AzureOpenAIDeploymentType')]"
                        },
                        {
                            "name": "FORM_RECOGNIZER_ENDPOINT",
                            "value": "[concat('https://',resourceGroup().location,'.api.cognitive.microsoft.com/')]"
                        },
                        {
                            "name": "FORM_RECOGNIZER_KEY",
                            "value": "[listKeys(concat('Microsoft.CognitiveServices/accounts/', parameters('FormRecognizerName')), '2023-05-01').key1]"
                        },
                        {
                            "name": "BLOB_ACCOUNT_NAME",
                            "value": "[parameters('StorageAccountName')]"
                        },
                        {
                            "name": "BLOB_ACCOUNT_KEY",
                            "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2019-06-01').keys[0].value]"
                        },
                        {
                            "name": "BLOB_CONTAINER_NAME",
                            "value": "[variables('BlobContainerName')]"
                        }
                    ],
                    "linuxFxVersion": "[variables('WebAppImageName')]"
                }
            }
        },
        {
            "apiVersion": "2020-06-01",
            "name": "[concat(parameters('WebsiteName'), '-admin')]",
            "type": "Microsoft.Web/sites",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('HostingPlanName'))]"
            ],
            "properties": {
                "serverFarmId": "[parameters('HostingPlanName')]",
                "siteConfig": {
                    "appSettings": [
                        {
                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                            "value": "[reference(resourceId('Microsoft.Insights/components', parameters('ApplicationInsightsName')), '2015-05-01').InstrumentationKey]"
                        },
                        {
                            "name": "AZURE_SEARCH_SERVICE",
                            "value": "[concat('https://',parameters('AzureCognitiveSearch'),'.search.windows.net')]"
                        },
                        {
                            "name": "AZURE_SEARCH_KEY",
                            "value": "[listAdminKeys(concat('Microsoft.Search/searchServices/', parameters('AzureCognitiveSearch')), '2021-04-01-preview').primaryKey]"
                        },
                        {
                            "name": "AZURE_SEARCH_INDEX",
                            "value": "[parameters('AzureSearchIndex')]"
                        },
                        {
                            "name": "AZURE_SEARCH_USE_SEMANTIC_SEARCH",
                            "value": "[parameters('AzureSearchUseSemanticSearch')]"
                        },
                        {
                            "name": "AZURE_SEARCH_SEMANTIC_SEARCH_CONFIG",
                            "value": "[parameters('AzureSearchSemanticSearchConfig')]"
                        },
                        {
                            "name": "AZURE_SEARCH_INDEX_IS_PRECHUNKED",
                            "value": "[parameters('AzureSearchIndexIsPrechunked')]"
                        },
                        {
                            "name": "AZURE_SEARCH_TOP_K",
                            "value": "[parameters('AzureSearchTopK')]"
                        },
                        {
                            "name": "AZURE_SEARCH_ENABLE_IN_DOMAIN",
                            "value": "[parameters('AzureSearchEnableInDomain')]"
                        },
                        {
                            "name": "AZURE_SEARCH_CONTENT_COLUMNS",
                            "value": "[parameters('AzureSearchContentColumns')]"
                        },
                        {
                            "name": "AZURE_SEARCH_FILENAME_COLUMN",
                            "value": "[parameters('AzureSearchFilenameColumn')]"
                        },
                        {
                            "name": "AZURE_SEARCH_TITLE_COLUMN",
                            "value": "[parameters('AzureSearchTitleColumn')]"
                        },
                        {
                            "name": "AZURE_SEARCH_URL_COLUMN",
                            "value": "[parameters('AzureSearchUrlColumn')]"
                        },
                        {
                            "name": "AZURE_OPENAI_RESOURCE",
                            "value": "[parameters('AzureOpenAIResource')]"
                        },
                        {
                            "name": "OPENAI_API_BASE",
                            "value": "[concat('https://',parameters('AzureOpenAIResource'),'.openai.azure.com/')]"
                        },
                        {
                            "name": "OPENAI_API_KEY",
                            "value": "[parameters('AzureOpenAIKey')]"
                        },
                        {
                            "name": "AZURE_OPENAI_MODEL",
                            "value": "[parameters('AzureOpenAIModel')]"
                        },
                        {
                            "name": "AZURE_OPENAI_KEY",
                            "value": "[parameters('AzureOpenAIKey')]"
                        },
                        {
                            "name": "AZURE_OPENAI_MODEL_NAME",
                            "value": "[parameters('AzureOpenAIModelName')]"
                        },
                        {
                            "name": "AZURE_OPENAI_TEMPERATURE",
                            "value": "[parameters('AzureOpenAITemperature')]"
                        },
                        {
                            "name": "AZURE_OPENAI_TOP_P",
                            "value": "[parameters('AzureOpenAITopP')]"
                        },
                        {
                            "name": "AZURE_OPENAI_MAX_TOKENS",
                            "value": "[parameters('AzureOpenAIMaxTokens')]"
                        },
                        {
                            "name": "AZURE_OPENAI_STOP_SEQUENCE",
                            "value": "[parameters('AzureOpenAIStopSequence')]"
                        },
                        {
                            "name": "AZURE_OPENAI_SYSTEM_MESSAGE",
                            "value": "[parameters('AzureOpenAISystemMessage')]"
                        },
                        {
                            "name": "AZURE_OPENAI_API_VERSION",
                            "value": "[parameters('AzureOpenAIApiVersion')]"
                        },
                        {
                            "name": "AZURE_OPENAI_STREAM",
                            "value": "[parameters('AzureOpenAIStream')]"
                        },
                        {
                            "name": "AZURE_OPENAI_KEY",
                            "value": "[parameters('AzureOpenAIKey')]"
                        },
                        {
                            "name": "BLOB_ACCOUNT_NAME",
                            "value": "[parameters('StorageAccountName')]"
                        },
                        {
                            "name": "BLOB_ACCOUNT_KEY",
                            "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2019-06-01').keys[0].value]"
                        },
                        {
                            "name": "BLOB_CONTAINER_NAME",
                            "value": "[variables('BlobContainerName')]"
                        },
                        {
                            "name": "FORM_RECOGNIZER_ENDPOINT",
                            "value": "[concat('https://',resourceGroup().location,'.api.cognitive.microsoft.com/')]"
                        },
                        {
                            "name": "FORM_RECOGNIZER_KEY",
                            "value": "[listKeys(concat('Microsoft.CognitiveServices/accounts/', parameters('FormRecognizerName')), '2023-05-01').key1]"
                        },
                        {
                            "name": "QUEUE_NAME",
                            "value": "[variables('QueueName')]"
                        },
                        {
                            "name": "BACKEND_URL",
                            "value": "[concat('https://', parameters('FunctionName') , '.azurewebsites.net')]"
                        },
                        {
                            "name": "FUNCTION_KEY",
                            "value": "[variables('ClientKey')]"
                        }                 
                    ],
                    "linuxFxVersion": "[variables('AdminWebAppImageName')]"
                }
            }
        },
        {
            "name": "[parameters('StorageAccountName')]",
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2021-08-01",
            "location": "[resourceGroup().location]",
            "kind": "StorageV2",
            "sku": {
                "name": "Standard_GRS"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "2021-08-01",
            "name": "[concat(parameters('StorageAccountName'), '/default/', variables('BlobContainerName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('StorageAccountName'))]"
            ],
            "properties": {
                "publicAccess": "None"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "2021-08-01",
            "name": "[concat(parameters('StorageAccountName'), '/default/', 'config')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('StorageAccountName'))]"
            ],
            "properties": {
                "publicAccess": "None"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/queueServices",
            "apiVersion": "2022-09-01",
            "name": "[concat(parameters('StorageAccountName'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('StorageAccountName'))]"
            ],
            "properties": {
                "cors": {
                    "corsRules": []
                }
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
            "apiVersion": "2022-09-01",
            "name": "[concat(parameters('StorageAccountName'), '/default/doc-processing')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/queueServices', parameters('StorageAccountName'), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('StorageAccountName'))]"
            ],
            "properties": {
                "metadata": {}
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
            "apiVersion": "2022-09-01",
            "name": "[concat(parameters('StorageAccountName'), '/default/doc-processing-poison')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/queueServices', parameters('StorageAccountName'), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('StorageAccountName'))]"
            ],
            "properties": {
                "metadata": {}
            }
        },
        {
            "type": "Microsoft.Insights/components",
            "apiVersion": "2020-02-02",
            "name": "[parameters('ApplicationInsightsName')]",
            "location": "[resourceGroup().location]",
            "tags": {
                "[concat('hidden-link:', resourceId('Microsoft.Web/sites', parameters('ApplicationInsightsName')))]": "Resource"
            },
            "properties": {
                "Application_Type": "web"
            },
            "kind": "web"
        },
        {
            "apiVersion": "2018-11-01",
            "name": "[parameters('FunctionName')]",
            "type": "Microsoft.Web/sites",
            "kind": "functionapp,linux",
            "location": "[resourceGroup().location]",
            "tags": {},
            "dependsOn": [
                "[concat('Microsoft.Web/serverfarms/', parameters('HostingPlanName'))]",
                "[concat('Microsoft.Storage/storageAccounts/', parameters('StorageAccountName'))]",
                "[concat('Microsoft.Insights/components/', parameters('ApplicationInsightsName'))]"
            ],
            "properties": {
                "name": "[parameters('FunctionName')]",
                "siteConfig": {            
                    "appSettings": [
                        {
                            "name": "FUNCTIONS_EXTENSION_VERSION",
                            "value": "~4"
                        },
                        {
                            "name": "WEBSITES_ENABLE_APP_SERVICE_STORAGE",
                            "value": "false"
                        },
                        {
                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                            "value": "[reference(resourceId('Microsoft.Insights/components', parameters('ApplicationInsightsName')), '2015-05-01').InstrumentationKey]"
                        },
                        {
                            "name": "AzureWebJobsStorage",
                            "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('StorageAccountName'),';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2019-06-01').keys[0].value,';EndpointSuffix=','core.windows.net')]"
                        },
                        {
                            "name": "AZURE_OPENAI_MODEL",
                            "value": "[parameters('AzureOpenAIModel')]"
                        },
                        {
                            "name": "OPENAI_EMBEDDINGS_ENGINE_DOC",
                            "value": "[parameters('AzureOpenAIEmbeddingModel')]"
                        },
                        {
                            "name": "AZURE_OPENAI_RESOURCE",
                            "value": "[parameters('AzureOpenAIResource')]"
                        },
                        {
                            "name": "AZURE_OPENAI_KEY",
                            "value": "[parameters('AzureOpenAIKey')]"
                        },
                        {
                            "name": "BLOB_ACCOUNT_NAME",
                            "value": "[parameters('StorageAccountName')]"
                        },
                        {
                            "name": "BLOB_ACCOUNT_KEY",
                            "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2019-06-01').keys[0].value]"
                        },
                        {
                            "name": "BLOB_CONTAINER_NAME",
                            "value": "[variables('BlobContainerName')]"
                        },
                        {
                            "name": "FORM_RECOGNIZER_ENDPOINT",
                            "value": "[concat('https://',resourceGroup().location,'.api.cognitive.microsoft.com/')]"
                        },
                        {
                            "name": "FORM_RECOGNIZER_KEY",
                            "value": "[listKeys(concat('Microsoft.CognitiveServices/accounts/', parameters('FormRecognizerName')), '2023-05-01').key1]"
                        },
                        {
                            "name": "AZURE_SEARCH_SERVICE",
                            "value": "[concat('https://',parameters('AzureCognitiveSearch'),'.search.windows.net')]"
                        },
                        {
                            "name": "AZURE_SEARCH_KEY",
                            "value": "[listAdminKeys(concat('Microsoft.Search/searchServices/', parameters('AzureCognitiveSearch')), '2021-04-01-preview').primaryKey]"
                        },
                        {
                            "name": "QUEUE_NAME",
                            "value": "[variables('QueueName')]"
                        }
                    ],
                    "cors": {
                        "allowedOrigins": [
                            "https://portal.azure.com"
                        ]
                    },
                    "use32BitWorkerProcess": false,
                    "linuxFxVersion": "[variables('BackendImageName')]",
                    "appCommandLine": "",
                    "alwaysOn": true
                },
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('HostingPlanName'))]",
                "clientAffinityEnabled": false,
                "virtualNetworkSubnetId": null,
                "httpsOnly": true
            }
        },
        {
            "type": "Microsoft.Web/sites/host/functionKeys",
            "apiVersion": "2018-11-01",
            "name": "[concat(parameters('FunctionName'), '/default/clientKey')]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('FunctionName'))]",
                "WaitFunctionDeploymentSection"
            ],
            "properties": {
                "name": "ClientKey",
                "value": "[variables('ClientKey')]"
            }
        },
        {
            "type": "Microsoft.Web/sites/config",
            "apiVersion": "2021-03-01",
            "name": "[format('{0}/{1}', parameters('WebsiteName'), 'appsettings')]",
            "kind": "string",
            "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('WebsiteName'))]",
                "[concat('Microsoft.Insights/components/', parameters('ApplicationInsightsName'))]"
            ],
            "properties": {
                "APPINSIGHTS_INSTRUMENTATIONKEY": "[reference(resourceId('Microsoft.Insights/components', parameters('ApplicationInsightsName')), '2015-05-01').InstrumentationKey]",
                "AZURE_OPENAI_MODEL": "[parameters('AzureOpenAIModel')]",
                "OPENAI_EMBEDDINGS_ENGINE_DOC": "[parameters('AzureOpenAIEmbeddingModel')]",
                "OPENAI_EMBEDDINGS_ENGINE_QUERY": "[parameters('AzureOpenAIEmbeddingModel')]",
                "AZURE_SEARCH_SERVICE": "[concat('https://',parameters('AzureCognitiveSearch'),'.search.windows.net')]",
                "AZURE_SEARCH_ADMIN_KEY": "[listAdminKeys(concat('Microsoft.Search/searchServices/', parameters('AzureCognitiveSearch')), '2021-04-01-preview').primaryKey]",
                "AZURE_SEARCH_INDEX": "[parameters('AzureSearchIndex')]",
                "AZURE_OPENAI_RESOURCE": "[parameters('AzureOpenAIResource')]",
                "AZURE_OPENAI_API_VERSION": ["parameters('AzureOpenAIApiVersion')"],
                "AZURE_OPENAI_KEY": "[parameters('AzureOpenAIKey')]",
                "BLOB_ACCOUNT_NAME": "[parameters('StorageAccountName')]",
                "BLOB_ACCOUNT_KEY": "[listkeys(resourceId('Microsoft.Storage/storageAccounts', parameters('StorageAccountName')), '2015-05-01-preview').key1]",
                "BLOB_CONTAINER_NAME": "[variables('BlobContainerName')]",
                "FORM_RECOGNIZER_ENDPOINT": "[concat('https://',resourceGroup().location,'.api.cognitive.microsoft.com/')]",
                "FORM_RECOGNIZER_KEY": "[listKeys(concat('Microsoft.CognitiveServices/accounts/', parameters('FormRecognizerName')), '2023-05-01').key1]",
            }
        },
        {
            "type": "Microsoft.Resources/deploymentScripts",
            "apiVersion": "2020-10-01",
            "kind": "AzurePowerShell",
            "name": "WaitFunctionDeploymentSection",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('FunctionName'))]"
            ],
            "properties": {
                "azPowerShellVersion": "3.0",
                "scriptContent": "start-sleep -Seconds 300",
                "cleanupPreference": "Always",
                "retentionInterval": "PT1H"
            }
        }
    ]
}
